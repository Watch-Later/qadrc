#!/bin/bash -efu

tmpdir=${TMPDIR:-/tmp}

AACGain15()
{
	local db1 db2 gain
	aacgain "$1" | tee $tmpdir/gain1.log
	db1=$(perl -lne 's/.*\s+dB change:\s+// and print 0+$_ and exit' $tmpdir/gain1.log)
	bs1770gain --replaygain "$1" | tee $tmpdir/gain2.log
	db2=$(perl -lne 's/.*integrated:.*\/\s+// and print 0+$_ and exit' $tmpdir/gain2.log)
	gain=$(perl -e '
		my $db = (shift() + shift) / 2;
		my $gain = $db / (5 * log(2) / log(10));
		my $igain = int(0.5 + abs $gain);
		$igain = -$igain if $igain and $gain < 0;
		print $igain if $igain;' -- ${db1:?} ${db2:?} )
	[ -z "$gain" ] ||
	aacgain -g "$gain" "$1"
}

for f; do
	AACGain15 "$f"
done
