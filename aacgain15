#!/bin/bash -efu

av0=$(readlink -ev "$0")
av0dir=$(dirname "$av0")

tmpdir=${TMPDIR:-/tmp}
dry_run=

AACGain15()
{
	local ff_decode_pre=
	if [[ $1 = *.[Mm][Pp]3 ]]; then
		ff_decode_pre='-acodec mp3float'
	fi
	ffmpeg $ff_decode_pre -i "$1" -vn -af replaygain,ebur128=framelog=verbose \
		-f null - >$tmpdir/gain$$.log 2>&1 || { grep -i error $tmpdir/gain$$.log; false; }
	local vars
	vars=$($av0dir/aacgain15pp <$tmpdir/gain$$.log)
	local $vars
	echo $vars
	[ ${g1igain:?} = 0 ] ||
	[ -n "$dry_run" ] ||
	aacgain -g "$g1igain" "$1" >&2
	rm $tmpdir/gain$$.log
}

if [ "${1-}" = "-n" ]; then
	dry_run=1
	shift
fi

for f; do
	AACGain15 "$f"
done
