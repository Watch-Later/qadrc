#!/bin/bash -efux

tmpdir=${TMPDIR:-/tmp}

av0=$(readlink -ev "$0")
av0dir=$(dirname "$av0")

alias lame='lame --disptime 1'

PrintIfMono()
{
	ffmpeg -i "$1" -vn -af pan=mono:"c0=0.5*c0+-0.5*c1" -ar 24000 \
		-aq 5 -compression_level 7 -y $tmpdir/diff.mp3 >$tmpdir/diff.log 2>&1
	local bitrate gain
	bitrate=$(perl -lne 'print int 0.85 + $1 while /bitrate=\s+(\d\S+)/g' <$tmpdir/diff.log |tail -1)
	if [ ${bitrate:?} -le 8 ]; then
		echo 1
		return
	fi
	if [ ${bitrate:?} -ge 32 ]; then
		return
	fi
	$av0dir/mp3gain99 $tmpdir/diff.mp3 >$tmpdir/gain.log 2>&1
	gain=$(perl -lne 's/.*\s+dB change:\s+// and print int $_ and exit' <$tmpdir/gain.log)
	if [ ${gain:?} -gt 20 ]; then
		echo 1
	fi
}

Transcode()
{
	vbr=4
	bitrate=$(avconv -i "$1" 2>&1 |
		  perl -ne '/^\s+Stream .* Audio: aac, .* ([1-9]\d\d?) kb/ and print $1 and exit')
	[ ${bitrate:?} -lt 200 ] || vbr=3

	gvars=$($av0dir/aacgain15 "$1")
	local $gvars
	local gain=${dbleft:?}

	mono=$(PrintIfMono "$1")
	echo '1 1' >$tmpdir/mono.matrix
	mono=${mono:+--matrix-file $tmpdir/mono.matrix}

	local drc=
	if [ "${range%.*}" -ge 10 ]; then
		vars=$(perl -le '
			use v5.12;
			my $range = shift;
			my $dbleft = shift;
			my $ratio  = 0 + sprintf "%.2f", $range / (9.9 + ($range - 9.9) / 3);
			my $thresh = 0 + sprintf "%.1f", -15 - $range - $dbleft;
			my $knee   = 0 + sprintf "%.1f", 2 * ($range + 10);
			say "ratio=$ratio thresh=$thresh knee=$knee";
			' -- $range $dbleft)
		local $vars
		drc="--drc $thresh:$ratio:$knee:20:800"

		local fast='-V5 -q9 --noreplaygain --nohist'
		[ -n "$mono" ] || fast="$fast -ms"

		qaac --silent --decode $mono $drc -o - "$1" |
		lame $fast /dev/stdin $tmpdir/drc.mp3

		gvars=$($av0dir/aacgain15 $tmpdir/drc.mp3)
		local $gvars
		gain=$(perl -le "print ${db:?} + (5-$vbr)*0.01")
	fi

	[ "$gain" != 0 ] || gain=
	gain=${gain:+--gain $gain}

	qaac --silent --decode $mono $drc $gain --limiter -o - "$1" |
	lame -V$vbr /dev/stdin "$2"
}

Transcode "$1" "${2:-${1%.*}.mp3}"
