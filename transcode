#!/bin/bash -efux

tmpdir=${TMPDIR:-/tmp}

av0=$(readlink -ev "$0")
av0dir=$(dirname "$av0")

# autodetect mono
mono=

Transcode()
{
	ffmpeg	-i "$1" -vn -af replaygain,ebur128=framelog=verbose,pan=mono:'c0=0.5*c0+-0.5*c1',replaygain=percent=99 \
		-f null - >$tmpdir/gain$$.log 2>&1 || { grep -i error $tmpdir/gain$$.log; false; }

	local vars
	vars=$($av0dir/aacgain15pp <$tmpdir/gain$$.log)
	local $vars

	local vbr=4
	[ ${g0brate:?} -lt 200 ] || vbr=3

	local gain=${g1db:?}

	case $mono in
		no) mono= ;;
		'') mono=$(perl -e "print 1 if ${g2db1:?} - $gain > 20") ;;
	esac

	echo '1 1' >$tmpdir/mono.matrix
	mono=${mono:+--matrix-file $tmpdir/mono.matrix}

	local drc=
	if [ "${g1range%.*}" -ge 10 ]; then
		vars=$(perl -le '
			use v5.12;
			my $range = shift;
			my $dbleft = shift;
			my $ratio  = 0 + sprintf "%.2f", $range / (9.9 + ($range - 9.9) / 3);
			my $thresh = 0 + sprintf "%.1f", -15 - $range - $dbleft;
			my $knee   = 0 + sprintf "%.1f", 2 * ($range + 10);
			say "ratio=$ratio thresh=$thresh knee=$knee";
			' -- $g1range $gain)
		local $vars
		drc="--drc $thresh:$ratio:$knee:20:800"

		qaac --silent --decode $mono $drc -o - "$1" |
		ffmpeg	-i - -vn -af replaygain,ebur128=framelog=verbose \
			-f null - >$tmpdir/gain$$.log 2>&1 || { grep -i error $tmpdir/gain$$.log; false; }
		vars=$($av0dir/aacgain15pp <$tmpdir/gain$$.log)
		local $vars
		gain=${g1db:?}
	fi

	[ "$gain" != 0 ] || gain=
	gain=${gain:+--gain $gain}

	qaac --silent --decode $mono $drc $gain --limiter -o - "$1" |
	lame -V$vbr /dev/stdin "$2"

	rm $tmpdir/gain$$.log
}

Transcode "$1" "${2:-${1%.*}.mp3}"
